<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Result</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/result.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/loader.css') }}">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11.4.10/dist/sweetalert2.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.4.10/dist/sweetalert2.min.js"></script>
</head>
<body>
    {% include 'header.html' %}

    <div class="main-container">
        <div class="container">
        {% if data %}
            {% for item in data %}
            <div class="product" data-product-name="{{ item.product_name }}">
                <div class="product-content">
                    <img src="{{ item.image_url }}" alt="{{ item.product_name }}">
                    <div class="product-details">
                        <h2>{{ item.product_name }}</h2>
                        <h3>{{ item.brand }}</h3>
                        <p>가격: {{ item.price }}</p>
                        <a href="{{ item.buy_url }}" target="_blank">구매하러가기</a>
                    </div>
                </div>
                <!-- 좋아요 버튼과 다른 상품 추천 버튼을 product 블록 내부로 이동 -->
                <div class="button-container">
                    <button class="refresh-btn">다른 상품 추천</button>
                    <button class="like-btn">상품 추천이 마음에 들어요</button>
                </div>
                <span class="likes-count hidden">좋아요 수: {{ item.likes if item.likes else 0 }}</span>
            </div>
            {% endfor %}
        {% else %}
            <p>데이터를 찾을 수 없습니다.</p>
        {% endif %}
        </div>
    </div>
    <div id="loading-screen" class="hidden-loading">
        <div class="loader">
            <h1>잠시만 기다려 주세요.</h1>
            <span></span>
            <span></span>
            <span></span>
        </div>
    </div>
    
    <script>
        $(document).ready(function() {
            // 다른 상품 추천 버튼 클릭 시
            $('.refresh-btn').on('click', function() {
                // 로딩 화면 표시
                $('#loading-screen').addClass('show');
        
                // 페이지 새로고침
                setTimeout(function() {
                    location.reload(true);
                }, 500); // 애니메이션이 끝날 때까지 대기 시간
            });
        
            // 상품 추천이 마음에 들어요 버튼 클릭 시
            $('.like-btn').on('click', function() {
                var $product = $(this).closest('.product');
                var productName = $product.data('product-name');
                var brand = $product.find('h2').text();
                var price = $product.find('p').text().replace('가격: ', '');
                var imageUrl = $product.find('img').attr('src');
                var buyUrl = $product.find('a').attr('href');
                
                $.ajax({
                    url: '/like',
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({
                        brand: brand,
                        product_name: productName,
                        price: price,
                        image_url: imageUrl,
                        buy_url: buyUrl
                    }),
                    success: function(response) {
                        if (response.success) {
                            var $likesCount = $product.find('.likes-count');
                            var currentCount = parseInt($likesCount.text().split(': ')[1]);
                            $likesCount.text('좋아요 수: ' + (currentCount + 1));
                            // 좋아요 버튼 클릭 후, 버튼 숨기기
                            $product.find('.like-btn').hide();
                    
                            // SweetAlert로 메시지 표시
                            Swal.fire({
                                icon: 'success',
                                title: '이용해 주셔서 감사합니다 :)'
                            });
                        } else {
                            // 오류 발생 시 SweetAlert로 오류 메시지 표시
                            Swal.fire({
                                icon: 'error',
                                title: '오류 발생',
                                text: '오류가 발생했습니다.'
                            });
                        }
                    },
                    error: function(jqXHR, textStatus, errorThrown) {
                    console.error('Error:', textStatus, errorThrown);
                    
                    // SweetAlert로 오류 메시지 표시
                    Swal.fire({
                        icon: 'error',
                        title: '통신 오류',
                        text: '서버와의 통신에 실패했습니다.'
                    });
                }
            });
        });
    });
        
    </script>
    {% include 'footer.html' %}
</body>
</html>
