<!DOCTYPE html>
<html lang="ko">
<head>
    <!-- 카카오 Maps API Script -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <title>선택된 메뉴</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100vh;
            margin: 0;
            background-color: #f0f0f0;
        }
        .container {
            height: 100%; /* 컨테이너의 높이를 100%로 설정 */
        }
        .row {
            height: 100%; /* 행의 높이를 100%로 설정 */
        }
        .col-md-4 {
            display: flex;
            flex-direction: column;
            justify-content: space-between; /* 콘텐츠를 위아래로 배치 */
            height: 100%; /* 열의 높이를 100%로 설정 */
        }
        /* 왼쪽 열 */
        .col-md-4.left-column {
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            width: 25%; /* 첫 번째 열의 너비를 25%로 설정 */
            height: 100%;
        }
        
        /* 중간 열 */
        .col-md-4.middle-column {
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            width: 25%; /* 두 번째 열의 너비를 25%로 설정 */
            height: 100%;
        }
        
        /* 오른쪽 열 */
        .col-md-4.right-column {
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            width: 50%; /* 세 번째 열의 너비를 50%로 설정 */
            height: 100%;
        }
        .menu-container {
            text-align: center;
            padding: 20px;
            border: 1px solid #007bff;
            border-radius: 10px;
            background-color: #fff;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            position: relative;
            flex: 1; /* 남은 공간을 차지하도록 설정 */
        }
        .menu-title {
            font-size: 24px;
            margin-bottom: 20px;
        }
        .menu-item {
            font-size: 20px;
            color: #333;
        }
        .menu-button {
            padding: 10px 20px;
            font-size: 16px;
            color: #fff;
            background-color: #007bff;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s ease;
            margin: 5px;
        }
        .menu-button:hover {
            background-color: #0056b3;
        }
        #map {
            width: 100%;
            height: 100%; /* 지도의 높이를 100%로 설정 */
            margin-top: 20px;
            position: relative;
        }
        .map-overlay-button {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 10;
        }
        .iframe-container {
            position: relative;
            width: 140%;
            height: 100%;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: #fff;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            display: none; /* 기본적으로 숨김 */
            overflow: hidden; /* overflow를 hidden으로 설정하여 스크롤 방지 */
            display: flex;
            justify-content: center;
            align-items: center;
        }
        iframe {
            width: 90%; /* iframe의 너비를 90%로 설정 */
            height: 90%; /* iframe의 높이를 90%로 설정 */
            border: none;
            object-fit: contain; /* iframe의 비율을 유지하면서 크기 조절 */
        }
        .col-md-4.hidden {
            display: none; /* 기본적으로 숨김 */
        }
        .restaurant-list {
            list-style: none;
            padding: 0;
        }
        .restaurant-item {
            border-bottom: 1px solid #ddd;
            padding: 10px 0;
            text-align: left;
        }
        .additional-button {
            position: absolute;
            top: 10px;
            left: 10px; /* 왼쪽 상단에 배치 */
            z-index: 10;
            background-color: #ffffff;
            padding: 5px 10px; /* 버튼의 패딩을 줄여서 크기를 축소 */
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px; /* 텍스트와 이미지 간의 간격 */
            justify-content: flex-start; /* 텍스트와 이미지를 왼쪽으로 정렬 */
        }
        
        .thumbs-up-icon-container {
            display: flex;
            align-items: center; /* 이미지의 세로 정렬 */
            margin-left: auto; /* 텍스트 오른쪽으로 이미지를 이동 */
        }
        
        .thumbs-up-icon {
            width: 16px; /* 아이콘의 크기를 줄임 */
            height: auto; /* 비율 유지 */
        }
        
        .thumbs-up-text {
            font-size: 14px; /* 텍스트 크기를 줄임 */
            color: #007bff;
        }
        
    </style>
</head>
<body>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>

    <div class="container text-center">
        <div class="row">
            <!-- 왼쪽 열 -->
            <div class="col-md-4 left-column">
                <div id="menu-container" class="menu-container">
                    <h1 class="menu-title">What eat</h1>
                    <div class="menu-item" id="menu-item">{{ menu if menu else '메뉴가 없습니다.' }}</div>
                    <img class="menu-image" id="menu-image" src="{{ url }}" alt="{{ menu }}" style="max-width: 100%; height: auto;"><br/>
                    <button class="menu-button" onclick="getAnotherMenu()">다른 메뉴 추천</button><br/>
                    <button class="menu-button" onclick="toggleIframe()">음식점 추천</button><br/>
                    <button class="menu-button" onclick="getAnotherRestaurant()">다른 음식점 추천</button><br/>
                    <!-- 음식점 리스트를 추가할 영역 -->
                    <ul id="restaurant-list" class="restaurant-list"></ul>
                </div>
            </div>

            <!-- 중간 열 -->
            <div class="col-md-4 middle-column">
                <div id="map" class="map">
                    <button class="map-overlay-button" onclick="locateCurrentPosition()">현재 위치 확인</button>
                </div>
            </div>

            <!-- 오른쪽 열 -->
            <div class="col-md-4 right-column hidden" id="iframe-column">
                <div id="iframe-container" class="iframe-container">
                    <iframe id="iframe" src="" frameborder="0"></iframe>
                    <div class="additional-button">
                        <span class="thumbs-up-text">음식 추천이 마음에 들어요</span>
                        <button class="thumbs-up-button" onclick="performAction()">
                            <img src="../static/images/thumbs_up.png" alt="마음에 들어요" class="thumbs-up-icon">
                        </button>
                    </div>
                </div>
            </div>                               
        </div>
    </div>

    <script>
        const category = "{{ category }}";
        let currentMenu = "{{ menu }}";
        let map;
        let infowindow;
        let currentAddress = '';
        let landAddress = '';
        let markers = [];
        let restaurantLink = ""; // 링크를 빈 문자열로 초기화

        // 초기 지도 설정
        function initMap() {
            const mapContainer = document.getElementById('map');
            const mapOption = {
                center: new kakao.maps.LatLng(37.566826, 126.9786567),
                level: 5
            };

            map = new kakao.maps.Map(mapContainer, mapOption);
            infowindow = new kakao.maps.InfoWindow({ zIndex: 1 });
        }

        function getAnotherMenu() {
            fetch(`/get_another_menu?category=${encodeURIComponent(category)}&current_menu=${encodeURIComponent(currentMenu)}`)
                .then(response => response.json())
                .then(data => {
                    if (data.menu) {
                        document.getElementById('menu-item').textContent = data.menu;
                        document.getElementById('menu-image').src = data.url;
                        currentMenu = data.menu;
                    } else {
                        alert('다른 메뉴를 가져오는 데 오류가 발생했습니다.');
                    }
                })
                .catch(error => {
                    console.error('Error fetching another menu:', error);
                    alert('다른 메뉴를 가져오는 데 오류가 발생했습니다.');
                });
        }

        function locateCurrentPosition() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    function(position) {
                        const lat = position.coords.latitude;
                        const lon = position.coords.longitude;
                        const newCenter = new kakao.maps.LatLng(lat, lon);
                        map.setCenter(newCenter);
                        map.setLevel(5); // 확대 레벨 조정
                        
                        // Reverse Geocoding API 요청
                        const geocoder = new kakao.maps.services.Geocoder();

                        geocoder.coord2Address(lon, lat, (result, status) => {
                            if (status === kakao.maps.services.Status.OK) {
                                // 도로명 주소
                                const roadAddress = result[0].road_address ? result[0].road_address.address_name : '';
                                // 지번 주소
                                landAddress = result[0].address.address_name;

                                currentAddress = roadAddress || landAddress;
                            } else {
                                console.error('주소를 가져오는 데 실패했습니다:', status);
                            }
                        });
                    },
                    function(error) {
                        console.error('Error getting location:', error);
                    }
                );
            } else {
                alert('이 브라우저는 Geolocation을 지원하지 않습니다.');
            }
        }

        function toggleIframe() {
            const iframeColumn = document.getElementById('iframe-column');
        
            if (iframeColumn.style.display === 'none' || iframeColumn.style.display === '') {
                iframeColumn.style.display = 'flex';
        
                // 현재 주소가 설정되어 있을 경우 식당 검색
                if (currentAddress) {
                    const parts = currentAddress.split(' ');
                    const subdistrict = parts.slice(2, 3).join(' '); // 두 번째 주소 부분
        
                    findNearbyRestaurants(subdistrict, currentMenu, false);
                } else {
                    alert('현재 위치를 먼저 확인해주세요.');
                }
            } else {
                iframeColumn.style.display = 'none'; // iframe 숨기기
            }
        }
        
        function getAnotherRestaurant() {
            // 현재 주소와 메뉴로 새로운 음식점 추천
            if (currentAddress) {
                const parts = currentAddress.split(' ');
                const subdistrict = parts.slice(2, 3).join(' '); // 두 번째 주소 부분
        
                findNearbyRestaurants(subdistrict, currentMenu, false);
            } else {
                alert('현재 위치를 먼저 확인해주세요.');
            }
        }
        

        function findNearbyRestaurants(address, menu, retry) {
            const ps = new kakao.maps.services.Places();

            const searchQuery = `${address} ${menu}`;
            console.log('검색어:', searchQuery);

            // 기존 마커 제거
            removeMarkers();

            const searchOptions = {
                location: map.getCenter(), // 현재 지도 중심을 위치로 사용
                radius: 1500 // 반경 설정 (단위: 미터)
            };

            ps.keywordSearch(searchQuery, placesSearchCB);
        
            function placesSearchCB(data, status) {
                console.log('검색 상태:', status);
                if (status === kakao.maps.services.Status.OK) {
                    const bounds = new kakao.maps.LatLngBounds();
                    // 검색된 장소를 지도에 마커로 표시
                    if (data.length > 0) {
                        // 랜덤으로 하나의 장소를 선택
                        const randomIndex = Math.floor(Math.random() * data.length);
                        const randomPlace = data[randomIndex];
                        restaurantLink = randomPlace.place_url;

                        // iframe에 링크 설정
                        const iframe = document.getElementById('iframe');
                        iframe.src = restaurantLink;

                        // 검색된 장소에 대한 마커 표시
                        for (let i = 0; i < data.length; i++) {
                            displayMarker(data[i]);
                            bounds.extend(new kakao.maps.LatLng(data[i].y, data[i].x));
                        }
                        map.setBounds(bounds);

                        // 음식점 리스트 업데이트
                        updateRestaurantList(data);
                    }
                } else {
                    if (!retry) {
                        findNearbyRestaurants(landAddress.split(' ').slice(2, 3).join(' '), menu, true);
                    } else {
                        alert('장소 검색에 실패했습니다. 다시 시도해 주세요.');
                    }
                }
            }
        
            function displayMarker(place) {
                const marker = new kakao.maps.Marker({
                    map: map,
                    position: new kakao.maps.LatLng(place.y, place.x)
                });

                markers.push(marker);

                // 마커 클릭 시 인포윈도우에 장소 정보 표시
                kakao.maps.event.addListener(marker, 'click', function() {
                    infowindow.setContent('<div style="padding:5px;font-size:12px;">' + place.place_name + '</div>');
                    infowindow.open(map, marker);
                });
            }
        }

        function updateRestaurantList(data) {
            const list = document.getElementById('restaurant-list');
            list.innerHTML = ''; // 기존 리스트 초기화

            data.forEach(place => {
                const listItem = document.createElement('li');
                listItem.className = 'restaurant-item';
                listItem.innerHTML = `
                    <strong>${place.place_name}</strong><br>
                    ${place.road_address_name || place.address_name}<br>
                    <a href="${place.place_url}" target="_blank">상세 보기</a>
                `;
                list.appendChild(listItem);
            });
        }

        function removeMarkers() {
            for (let i = 0; i < markers.length; i++) {
                markers[i].setMap(null);
            }
            markers = [];
        }

        window.onload = initMap;
    </script>
</body>
</html>
