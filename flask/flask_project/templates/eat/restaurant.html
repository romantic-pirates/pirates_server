<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/restaurant.css') }}">
    <title>음식점 추천</title>
    <script type="text/javascript" src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=564c3a19dd3a8e8bf077ecfe7447fd77&libraries=services"></script>
</head>
<body>
    {% include 'header.html' %}
    <div class="button-container">
        <button id="recommend-button" class="menu-button" onclick="recommendAnotherRestaurant()">다른 음식점 추천</button>
        <button id="like-button" class="menu-button" onclick="likePlace()">추천이 마음에 들어요</button>
        <button id="hide-map-button" class="menu-button" onclick="toggleMapWrap()">지도 숨기기</button>
    </div>
    <div class="button-container">
        <iframe id="iframe" frameborder="0"></iframe>
    </div>
    <div class="map_wrap" id="mapWrap">
        <div id="map"></div>
        <div id="menu_wrap">
            <ul id="placesList"></ul>
        </div>
    </div>

    <script>
        let map;
        let infowindow;
        let restaurantData = [];
        let lastPlaceUrl = '';
        let markers = [];

        const markerImageUrls = {
            default: '{{ url_for('static', filename='images/default_marker.png') }}',
            recommended: '{{ url_for('static', filename='images/recommended_marker.png') }}'
        };

        const params = new URLSearchParams(window.location.search);
        const address = decodeURIComponent(params.get('address')) || '서울';
        const menu = decodeURIComponent(params.get('menu')) || '';

        function initMap() {
            const mapContainer = document.getElementById('map');
            const mapOption = {
                center: new kakao.maps.LatLng(37.566826, 126.9786567),
                level: 5
            };

            map = new kakao.maps.Map(mapContainer, mapOption);
            infowindow = new kakao.maps.InfoWindow({ zIndex: 1 });

            findNearbyRestaurants(address, menu);
        }

        function findNearbyRestaurants(address, menu) {
            const ps = new kakao.maps.services.Places();
            const searchQuery = `${address} ${menu}`;

            ps.keywordSearch(searchQuery, placesSearchCB);

            function placesSearchCB(data, status) {
                if (status === kakao.maps.services.Status.OK) {
                    const bounds = new kakao.maps.LatLngBounds();
                    restaurantData = [];
                    const results = [];

                    data.forEach((place, index) => {
                        restaurantData.push({
                            place_name: place.place_name,
                            road_address_name: place.road_address_name || place.address_name,
                            place_url: place.place_url,
                            x: place.x,
                            y: place.y,
                            markerIndex: index + 1
                        });
                        results.push({
                            place_name: place.place_name,
                            road_address_name: place.road_address_name || place.address_name,
                            place_url: place.place_url,
                            x: place.x,
                            y: place.y,
                            markerIndex: index + 1
                        });
                        displayMarker(place, false);
                        bounds.extend(new kakao.maps.LatLng(place.y, place.x));
                    });

                    map.setBounds(bounds);
                    map.setLevel(5);
                    updateRestaurantList(results);

                    if (results.length > 0) {
                        const firstPlace = results[0];
                        document.getElementById('iframe').src = firstPlace.place_url;
                        lastPlaceUrl = firstPlace.place_url;
                        document.getElementById('like-button').classList.remove('hidden');
                        updateInitialRecommendedMarker(firstPlace);
                    }
                } else {
                    alert('주변에 해당 음식점이 없어요 :(\n다른 메뉴를 추천 받아주세요 :)');
                }
            }
        }

        function displayMarker(place, isRecommended = false) {
            const markerImageSrc = isRecommended ? markerImageUrls.recommended : markerImageUrls.default;
            const markerImage = new kakao.maps.MarkerImage(markerImageSrc, new kakao.maps.Size(36, 36));

            const marker = new kakao.maps.Marker({
                map: map,
                position: new kakao.maps.LatLng(place.y, place.x),
                image: markerImage
            });

            kakao.maps.event.addListener(marker, 'click', function() {
                infowindow.setContent(`<div style="padding:5px;">${place.place_name}<br><a href="${place.place_url}" target="_blank">상세 보기</a></div>`);
                infowindow.open(map, marker);
            });

            markers.push(marker);
        }

        function updateRestaurantList(data) {
            const list = document.getElementById('placesList');
            list.innerHTML = '';

            data.forEach((place) => {
                const listItem = document.createElement('li');
                listItem.className = 'item';
                listItem.innerHTML = `
                    <div class="markerbg marker_${place.markerIndex}"></div>
                    <h5>${place.place_name}</h5>
                    <div class="info">
                        <span class="jibun">${place.road_address_name}</span>
                        <span class="tel"><a href="tel:${place.phone || ''}">${place.phone || ''}</a></span>
                    </div>
                `;
                listItem.addEventListener('click', () => {
                    document.getElementById('iframe').src = place.place_url;
                    lastPlaceUrl = place.place_url;
                });
                list.appendChild(listItem);
            });
        }

        function updateInitialRecommendedMarker(recommendedPlace) {
            markers.forEach(marker => {
                marker.setMap(null);
            });
            markers = [];

            restaurantData.forEach((place) => {
                displayMarker(place, place.place_url === recommendedPlace.place_url);
            });
        }

        function recommendAnotherRestaurant() {
            if (restaurantData.length > 0) {
                const availablePlaces = restaurantData.filter(place => place.place_url !== lastPlaceUrl);

                if (availablePlaces.length === 0) {
                    alert('추천할 음식점이 없습니다.');
                    return;
                }

                const randomIndex = Math.floor(Math.random() * availablePlaces.length);
                const selectedPlace = availablePlaces[randomIndex];

                document.getElementById('iframe').src = selectedPlace.place_url;
                lastPlaceUrl = selectedPlace.place_url;

                markers.forEach(marker => marker.setMap(null));
                markers = [];

                restaurantData.forEach((place) => {
                    displayMarker(place, place.place_url === lastPlaceUrl);
                });

                document.getElementById('like-button').classList.remove('hidden');
            } else {
                alert('추천할 음식점이 없습니다.');
            }
        }

        function likePlace() {
            const iframe = document.getElementById('iframe');
            const place_url = iframe ? iframe.src : window.location.href;
            alert('이용해주셔서 감사합니다 :)');

            fetch('/likePlace', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    place_url: place_url
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.getElementById('like-button').classList.add('hidden');
                } else {
                    alert('좋아요를 처리하는 데 오류가 발생했습니다.');
                }
            })
            .catch(error => {
                console.error('Error liking place:', error);
                alert('좋아요를 처리하는 데 오류가 발생했습니다.');
            });
        }

        function toggleMapWrap() {
            const mapWrap = document.getElementById('mapWrap');
            const iframe = document.getElementById('iframe');
            const button = document.getElementById('hide-map-button');

            if (mapWrap.classList.contains('hidden')) {
                mapWrap.classList.remove('hidden');
                iframe.style.height = '50vh'; // 기본 높이로 복구
                button.textContent = '지도 숨기기';
            } else {
                mapWrap.classList.add('hidden');
                iframe.style.height = '100vh'; // 높이를 전체 화면으로 조정
                button.textContent = '지도 보이기';
            }
        }

        window.onload = function() {
            initMap();
        };

    </script>
    {% include 'footer.html' %}
</body>
</html>
